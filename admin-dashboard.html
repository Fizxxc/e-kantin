<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Kantin â€” Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{background:#f1f5f9}
.card{transition:.15s}
.card:hover{transform:translateY(-4px)}
</style>
</head>

<body class="min-h-screen">

<!-- HEADER -->
<header class="bg-white shadow p-4 flex justify-between items-center">
  <div>
    <h1 class="text-xl font-bold">Admin Kantin</h1>
    <div id="adminEmail" class="text-sm text-gray-500">memuat...</div>
  </div>
  <div class="flex gap-2">
    <button id="scanBtn" class="px-3 py-2 bg-amber-500 text-white rounded">Scan QR</button>
    <button id="logoutBtn" class="px-3 py-2 bg-red-600 text-white rounded">Logout</button>
  </div>
</header>

<!-- MAIN -->
<main class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">

<!-- MENU -->
<section class="bg-white rounded-xl p-4 shadow lg:col-span-1">
  <div class="flex justify-between mb-3">
    <h2 class="font-semibold">Menu</h2>
    <button onclick="openMenu()" class="px-3 py-1 bg-indigo-600 text-white rounded">Tambah</button>
  </div>
  <div id="menuList" class="space-y-3"></div>
</section>

<!-- ORDERS -->
<section class="bg-white rounded-xl p-4 shadow lg:col-span-2">
  <h2 class="font-semibold mb-3">Pesanan Masuk</h2>
  <div id="orderList" class="space-y-3 max-h-[70vh] overflow-auto"></div>
</section>

</main>

<!-- MODAL MENU -->
<div id="menuModal" class="fixed inset-0 hidden bg-black/40 flex items-center justify-center">
<div class="bg-white p-4 rounded-xl w-full max-w-md">
<h3 id="menuTitle" class="font-bold mb-3">Tambah Menu</h3>
<input id="mName" placeholder="Nama" class="w-full border p-2 mb-2 rounded">
<input id="mPrice" type="number" placeholder="Harga" class="w-full border p-2 mb-2 rounded">
<textarea id="mDesc" placeholder="Deskripsi" class="w-full border p-2 mb-2 rounded"></textarea>
<input id="mImg" type="file" accept="image/*" class="mb-3">

<div class="flex justify-end gap-2">
<button onclick="closeMenu()" class="px-3 py-2 bg-gray-300 rounded">Batal</button>
<button id="saveMenu" class="px-3 py-2 bg-indigo-600 text-white rounded">Simpan</button>
</div>
</div>
</div>

<!-- QR MODAL -->
<div id="qrModal" class="fixed inset-0 hidden bg-black/50 flex items-center justify-center">
<div class="bg-white p-4 rounded-xl w-full max-w-sm">
<h3 class="font-bold mb-2">Scan QR Order</h3>
<div id="reader" class="w-full"></div>
<button onclick="closeQR()" class="mt-3 w-full bg-red-500 text-white py-2 rounded">Tutup</button>
</div>
</div>

<script type="module">
import {
  authState, logout, isAdmin,
  listenMenu, addMenu, updateMenu, deleteMenu, uploadImage,
  listenOrders, callQueue, updateOrder
} from "./js/firebase.js";

let menus=[], orders=[], editId=null;
let lastQueue=0;
let qr=null;

// ===== AUTH =====
authState(async u=>{
  if(!u) return location.href="/admin-login";
  if(!(await isAdmin(u.uid))){
    await Swal.fire("Akses ditolak","","error");
    return location.href="/";
  }
  adminEmail.textContent=u.email;
  init();
});

// ===== INIT =====
function init(){
  listenMenu(list=>{menus=list;renderMenu()});
  listenOrders(list=>{
    orders=list.sort((a,b)=>a.createdAt-b.createdAt);
    lastQueue=Math.max(0,...orders.map(o=>o.called||0));
    renderOrders();
  });
}

// ===== MENU =====
function renderMenu(){
  menuList.innerHTML=menus.map(m=>`
  <div class="card p-3 border rounded">
    <div class="font-semibold">${m.title}</div>
    <div class="text-sm">Rp ${Number(m.price).toLocaleString()}</div>
    <div class="flex gap-2 mt-2">
      <button onclick="editMenu('${m.id}')" class="text-sm bg-yellow-400 px-2 rounded">Edit</button>
      <button onclick="removeMenu('${m.id}')" class="text-sm bg-red-500 text-white px-2 rounded">Hapus</button>
    </div>
  </div>`).join('');
}

window.openMenu=()=>{menuModal.classList.remove("hidden");editId=null}
window.closeMenu=()=>menuModal.classList.add("hidden");

window.editMenu=id=>{
  const m=menus.find(x=>x.id===id);
  editId=id;
  mName.value=m.title;
  mPrice.value=m.price;
  mDesc.value=m.desc||"";
  openMenu();
};

window.removeMenu=async id=>{
  if((await Swal.fire({title:"Hapus?",showCancelButton:true})).isConfirmed)
    await deleteMenu(id);
};

saveMenu.onclick=async()=>{
  const img=mImg.files[0];
  let url="";
  if(img) url=await uploadImage(img,"menu");
  const data={title:mName.value,price:+mPrice.value,desc:mDesc.value,imageUrl:url};
  editId?await updateMenu(editId,data):await addMenu(data);
  closeMenu();
};

// ===== ORDERS =====
function renderOrders(){
  orderList.innerHTML=orders.map(o=>`
  <div class="card p-3 border rounded">
    <div class="flex justify-between">
      <div>
        <div class="font-semibold">Order ${o.id}</div>
        <div class="text-sm">Total Rp ${Number(o.total).toLocaleString()}</div>
      </div>
      <div class="flex gap-2">
        <button onclick="verify('${o.id}')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs">Verifikasi</button>
        <button onclick="call('${o.id}')" class="px-2 py-1 bg-green-600 text-white rounded text-xs">Panggil</button>
      </div>
    </div>
    ${o.called?`<div class="mt-2 text-indigo-600 font-bold">No ${o.called}</div>`:""}
  </div>`).join('');
}

window.call=async id=>{
  lastQueue++;
  await callQueue(id,lastQueue);
  speechSynthesis.speak(new SpeechSynthesisUtterance(`Nomor ${lastQueue}`));
};

window.verify=id=>{
  location.href=`/admin-confirm?order=${id}`;
};

// ===== QR =====
scanBtn.onclick=()=>{
  qrModal.classList.remove("hidden");
  qr=new Html5Qrcode("reader");
  qr.start({facingMode:"environment"},{fps:10,qrbox:250},txt=>{
    qr.stop();
    closeQR();
    location.href=`/admin-confirm?order=${txt}`;
  });
};

window.closeQR=()=>{qrModal.classList.add("hidden");qr?.stop()};

// ===== LOGOUT =====
logoutBtn.onclick=async()=>{await logout();location.href="/"};

</script>
</body>
</html>
