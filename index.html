<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kantin - User (Realtime)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.lordicon.com/lusqsztk.js"></script>

  <style>
    #menuGrid { display:grid; gap:1rem; grid-template-columns: 1fr; }
    @media(min-width:640px){ #menuGrid{ grid-template-columns: repeat(2,1fr);} }
    @media(min-width:1024px){ #menuGrid{ grid-template-columns: repeat(3,1fr);} }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div>
        <div id="greeting" class="text-lg font-semibold">Selamat Datang!</div>
        <div id="userNote" class="text-sm text-slate-500">Login untuk memesan dan menerima notifikasi.</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="cartBtn" class="px-4 py-2 bg-indigo-600 text-white rounded" onclick="openCart()">
          Keranjang (<span id="cartCount">0</span>)
        </button>
        <button id="authBtn" class="px-4 py-2 bg-white border rounded" onclick="openAuth()">Login / Register</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <aside class="md:col-span-1 bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">Daftar Menu</h3>
        <div id="sideMenu" class="space-y-2 text-sm text-slate-600"></div>
      </aside>

      <section class="md:col-span-3">
        <div class="bg-white p-4 rounded shadow mb-4 flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold">Pilih Menu</h2>
            <p class="text-sm text-slate-500">Tambahkan ke keranjang lalu checkout.</p>
          </div>
          <div class="text-sm text-slate-500">Metode: QRIS / Cash</div>
        </div>

        <div id="menuGrid"></div>
      </section>
    </main>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="fixed inset-0 bg-black/40 hidden items-end md:items-center justify-center p-4 z-50">
    <div class="bg-white w-full md:w-2/3 rounded-t-lg md:rounded-lg p-4 shadow">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-semibold">Keranjang</h3>
        <button onclick="closeCart()" class="text-sm text-slate-500">Tutup</button>
      </div>
      <div id="cartItems" class="space-y-2 max-h-64 overflow-auto"></div>
      <div class="mt-3 flex justify-between items-center">
        <div>Total: Rp <span id="cartTotal">0</span></div>
        <div class="flex gap-2">
          <button class="px-3 py-2 bg-gray-200 rounded" onclick="clearCart()">Kosongkan</button>
          <button class="px-3 py-2 bg-indigo-600 text-white rounded" onclick="openCheckout()">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-md rounded-lg p-4 shadow">
      <h3 class="font-semibold mb-3">Login / Register</h3>
      <input id="authEmail" class="w-full p-2 border rounded mb-2" placeholder="Email" />
      <input id="authPassword" type="password" class="w-full p-2 border rounded mb-3" placeholder="Password" />
      <div class="flex gap-2">
        <button class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded" id="btnDoLogin">Login</button>
        <button class="flex-1 px-3 py-2 bg-green-600 text-white rounded" id="btnDoRegister">Register</button>
      </div>
      <p class="mt-3 text-sm text-slate-500">Login dulu yaa,atau Register kalau belum punya akunn!!</p>
      <div class="mt-2 text-right"><button class="text-sm text-slate-500" onclick="closeAuth()">Tutup</button></div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-2xl rounded-lg p-4 shadow">
      <h3 class="font-semibold mb-3">Checkout</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="p-3 border rounded">
          <h4 class="font-semibold">QRIS</h4>
          <img id="qrisImage" class="w-full rounded mt-2" src="https://via.placeholder.com/320x180?text=QRIS" />
          <div class="mt-3 text-right"><button class="px-3 py-2 bg-indigo-600 text-white rounded" id="btnQrisPaid">Saya Sudah Bayar</button></div>
        </div>
        <div class="p-3 border rounded">
          <h4 class="font-semibold">Cash</h4>
          <div class="flex justify-center mt-2"><canvas id="cashQR"></canvas></div>
          <div class="mt-3 text-right"><button class="px-3 py-2 bg-indigo-600 text-white rounded" id="btnCashPay">Bayar di Kasir</button></div>
        </div>
      </div>
      <div class="mt-3 text-right"><button class="px-3 py-2 bg-gray-200 rounded" onclick="closeCheckout()">Tutup</button></div>
    </div>
  </div>

  <section class="bg-white rounded-xl shadow p-4 max-w-md mx-auto mt-6">
  <h2 class="text-lg font-bold text-center mb-3">ðŸ“¢ Antrian Kantin</h2>

  <!-- Antrian Dipanggil -->
  <div class="bg-indigo-600 text-white rounded-xl p-4 text-center mb-4">
    <div class="text-sm">Sedang Dipanggil</div>
    <div id="currentQueue" class="text-5xl font-bold">-</div>
  </div>

  <!-- Status User -->
  <div class="border rounded-xl p-3">
    <div class="text-sm text-gray-500">Status Pesanan Anda</div>
    <div id="userStatus" class="font-semibold text-lg">Memuat...</div>
    <div id="userQueue" class="text-indigo-600 font-bold mt-1"></div>
  </div>
</section>

<script type="module">
import {
  listenMenu, placeOrder, listenOrders,
  loginUser, registerUser, logout, authState
} from "./js/firebase.js";

// STATE
let user = null;
let cart = [];

// DOM
const menuGrid = document.getElementById("menuGrid");
const sideMenu = document.getElementById("sideMenu");
const cartCountEl = document.getElementById('cartCount');

// BUTTON EVENTS
document.getElementById('btnDoLogin').addEventListener('click', doLogin);
document.getElementById('btnDoRegister').addEventListener('click', doRegister);
document.getElementById('btnQrisPaid').addEventListener('click', ()=>confirmPayment('qris'));
document.getElementById('btnCashPay').addEventListener('click', ()=>confirmPayment('cash'));

// LISTEN MENU
listenMenu(renderMenu);

function renderMenu(data) {
  sideMenu.innerHTML = data.length 
    ? data.map(m => `<div class="flex justify-between"><div>${m.title}</div><div>Rp ${Number(m.price).toLocaleString()}</div></div>`).join("")
    : '<div class="text-slate-500">Belum ada menu</div>';

  menuGrid.innerHTML = data.map(m => `
    <div class="bg-white rounded shadow p-3 flex flex-col">
      <img src="${m.imageUrl || 'https://via.placeholder.com/420x240?text=No+Image'}"
           class="h-40 w-full object-cover rounded mb-3">
      <div class="flex-1">
        <h4 class="font-semibold">${m.title}</h4>
        <div class="text-sm text-slate-500">${m.desc || ''}</div>
      </div>
      <div class="mt-3 flex items-center justify-between">
        <div class="font-semibold">Rp ${Number(m.price).toLocaleString()}</div>
        <button class="px-3 py-1 bg-indigo-600 text-white rounded"
          onclick="addToCart('${m.id}','${m.title}',${m.price})">Tambah</button>
      </div>
    </div>
  `).join('');
}

// CART CONTROL
function addToCart(id,title,price){
  const f = cart.find(x=>x.id===id);
  if(f) f.qty++;
  else cart.push({id,title,price:+price,qty:1});
  renderCartCount();
  Swal.fire({ icon:'success', title:'Ditambahkan', text:title, timer:700, showConfirmButton:false });
}

function renderCartCount(){
  cartCountEl.textContent = cart.reduce((s,i)=>s+i.qty,0);
}

function openCart(){
  document.getElementById('cartModal').classList.remove('hidden');
  renderCartItems();
}
function closeCart(){
  document.getElementById('cartModal').classList.add('hidden');
}
function clearCart(){
  cart = [];
  renderCartItems();
  renderCartCount();
}

function renderCartItems(){
  const wrap = document.getElementById('cartItems');
  if(cart.length === 0){
    wrap.innerHTML = '<div class="text-slate-500">Keranjang kosong</div>';
  } else {
    wrap.innerHTML = cart.map(i => `
      <div class="flex justify-between items-center border-b py-2">
        <div>
          <div class="font-semibold">${i.title}</div>
          <div class="text-sm text-slate-500">Rp ${i.price.toLocaleString()} x ${i.qty}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 bg-gray-200 rounded" onclick="dec('${i.id}')">-</button>
          <div>${i.qty}</div>
          <button class="px-2 py-1 bg-gray-200 rounded" onclick="inc('${i.id}')">+</button>
        </div>
      </div>
    `).join('');
  }

  document.getElementById('cartTotal').textContent =
    cart.reduce((s,i)=>s+i.price*i.qty,0).toLocaleString();
}

function inc(id){
  const f = cart.find(x=>x.id===id);
  if(f){ f.qty++; renderCartItems(); renderCartCount(); }
}
function dec(id){
  const f = cart.find(x=>x.id===id);
  if(f){
    f.qty--;
    if(f.qty <= 0) cart = cart.filter(x=>x.id!==id);
    renderCartItems();
    renderCartCount();
  }
}

// AUTH
function openAuth(){
  document.getElementById('authModal').classList.remove('hidden');
}
function closeAuth(){
  document.getElementById('authModal').classList.add('hidden');
}

async function doRegister(){
  const e = document.getElementById('authEmail').value.trim();
  const p = document.getElementById('authPassword').value.trim();
  if(!e||!p) return Swal.fire('Error','Isi email & password','error');
  try{
    await registerUser(e,p);
    Swal.fire('Sukses','Akun dibuat','success');
    closeAuth();
  }catch(err){
    Swal.fire('Gagal', err.message, 'error');
  }
}

async function doLogin(){
  const e = document.getElementById('authEmail').value.trim();
  const p = document.getElementById('authPassword').value.trim();
  if(!e||!p) return Swal.fire('Error','Isi email & password','error');
  try{
    await loginUser(e,p);
    Swal.fire('Sukses','Login berhasil','success');
    closeAuth();
  }catch(err){
    Swal.fire('Gagal', err.message, 'error');
  }
}

// CHECKOUT
function openCheckout(){
  if(!user) return Swal.fire('Login dulu','Silakan login untuk checkout','info').then(openAuth);
  if(cart.length===0) return Swal.fire('Kosong','Keranjang kosong','info');
  document.getElementById('checkoutModal').classList.remove('hidden');
  QRCode.toCanvas(document.getElementById('cashQR'), 'ready-to-pay', { width: 160 });
}
function closeCheckout(){
  document.getElementById('checkoutModal').classList.add('hidden');
}

async function confirmPayment(method){
  if(!user){
    Swal.fire("Login dulu"); return openAuth();
  }

  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);

  const order = {
    items: cart,
    total,
    payment: { method, status: method === 'qris' ? 'waiting_verif' : 'waiting_scan' }
  };

  try{
    const id = await placeOrder(user.uid, order);
    clearCart();
    closeCheckout();

    if(method === "cash"){
      Swal.fire({
        title:"Tunjukkan barcode ke kasir",
        html:`<div id="orderqr"></div>`,
        didOpen:()=>QRCode.toCanvas(document.getElementById("orderqr"), id,{width:220})
      });
    } else {
      Swal.fire("Berhasil","Silakan tunggu verifikasi","success");
    }
  }catch(err){
    Swal.fire("Error","Gagal membuat pesanan","error");
  }
}

// AUTH STATE LISTENER
authState(u => {
  user = u;
  if(user){
    document.getElementById('greeting').textContent = 'Halo, ' + user.email.split('@')[0];
    document.getElementById('authBtn').textContent = "Logout";
    document.getElementById('authBtn').onclick = async()=>{ await logout(); location.reload(); };

  } else {
    document.getElementById('greeting').textContent = "Selamat Datang!";
    document.getElementById('authBtn').textContent = "Login / Register";
    document.getElementById('authBtn').onclick = openAuth;
  }
});

// NOTIFICATIONS ON ORDER CALLED
listenOrders(list => {
  if(!user) return;

  list.forEach(o=>{
    if(o.userId === user.uid && o.called && !o._notified){
      o._notified = true;
      const text = `Nomor antrian Anda: ${o.queue}`;
      Swal.fire({ icon:'info', title:'Dipanggil', text });
      if("speechSynthesis" in window){
        let s = new SpeechSynthesisUtterance(text);
        s.lang = 'id-ID';
        speechSynthesis.speak(s);
      }
    }
  });
});

// antiran logic
let myUid = null;

// ambil UID user
authState(user => {
  if (!user) return;
  myUid = user.uid;
});

// realtime orders
listenOrders(orders => {
  if (!orders.length) return;

  // ðŸ”” Cari antrian yang sedang dipanggil (terbesar & aktif)
  const called = orders
    .filter(o => o.called)
    .sort((a,b)=>b.called - a.called)[0];

  document.getElementById("currentQueue").textContent =
    called ? called.called : "-";

  // ðŸ‘¤ Cari order milik user
  const myOrder = orders
    .filter(o => o.userId === myUid)
    .sort((a,b)=>b.createdAt - a.createdAt)[0];

  if (!myOrder) {
    userStatus.textContent = "Belum memesan";
    userQueue.textContent = "";
    return;
  }

  // status text
  let statusText = "Menunggu";
  if (myOrder.status === "called") statusText = "Dipanggil";
  if (myOrder.status === "done") statusText = "Selesai";

  userStatus.textContent = statusText;

  // nomor antrian
  userQueue.textContent = myOrder.called
    ? "Nomor Antrian: " + myOrder.called
    : "Menunggu dipanggil";
});

// expose to window (agar onclick bekerja)
window.addToCart       = addToCart;
window.openCart        = openCart;
window.closeCart       = closeCart;
window.clearCart       = clearCart;
window.inc             = inc;
window.dec             = dec;
window.openAuth        = openAuth;
window.closeAuth       = closeAuth;
window.doLogin         = doLogin;
window.doRegister      = doRegister;
window.openCheckout    = openCheckout;
window.closeCheckout   = closeCheckout;
window.confirmPayment  = confirmPayment;
</script>
</body>
</html>
