<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kantin - User</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.lordicon.com/lusqsztk.js"></script>

  <style>
    /* simple mobile-first grid */
    #menuGrid { display: grid; gap: 1rem; grid-template-columns: 1fr; }
    @media(min-width:640px){ #menuGrid{ grid-template-columns: repeat(2,1fr);} }
    @media(min-width:1024px){ #menuGrid{ grid-template-columns: repeat(3,1fr);} }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div>
        <div id="greeting" class="text-lg font-semibold">Selamat Datang!</div>
        <div id="userNote" class="text-sm text-slate-500">Login untuk memesan dan menerima notifikasi.</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="cartBtn" class="px-4 py-2 bg-indigo-600 text-white rounded" onclick="openCart()">Keranjang (<span id="cartCount">0</span>)</button>
        <button id="authBtn" class="px-4 py-2 bg-white border rounded" onclick="openAuth()">Login / Register</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <aside class="md:col-span-1 bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">Daftar Menu</h3>
        <div id="sideMenu" class="space-y-2 text-sm text-slate-600"></div>
      </aside>

      <section class="md:col-span-3">
        <div class="bg-white p-4 rounded shadow mb-4 flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold">Pilih Menu</h2>
            <p class="text-sm text-slate-500">Tambahkan ke keranjang lalu checkout.</p>
          </div>
          <div class="text-sm text-slate-500">Metode: QRIS / Cash</div>
        </div>

        <div id="menuGrid"></div>
      </section>
    </main>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="fixed inset-0 bg-black/40 hidden items-end md:items-center justify-center p-4 z-50">
    <div class="bg-white w-full md:w-2/3 rounded-t-lg md:rounded-lg p-4 shadow">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-semibold">Keranjang</h3>
        <button onclick="closeCart()" class="text-sm text-slate-500">Tutup</button>
      </div>
      <div id="cartItems" class="space-y-2 max-h-64 overflow-auto"></div>
      <div class="mt-3 flex justify-between items-center">
        <div>Total: Rp <span id="cartTotal">0</span></div>
        <div class="flex gap-2">
          <button class="px-3 py-2 bg-gray-200 rounded" onclick="clearCart()">Kosongkan</button>
          <button class="px-3 py-2 bg-indigo-600 text-white rounded" onclick="openCheckout()">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-md rounded-lg p-4 shadow">
      <h3 class="font-semibold mb-3">Login / Register</h3>
      <input id="authEmail" class="w-full p-2 border rounded mb-2" placeholder="Email" />
      <input id="authPassword" type="password" class="w-full p-2 border rounded mb-3" placeholder="Password" />
      <div class="flex gap-2">
        <button class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded" onclick="doLogin()">Login</button>
        <button class="flex-1 px-3 py-2 bg-green-600 text-white rounded" onclick="doRegister()">Register</button>
      </div>
      <p class="mt-3 text-sm text-slate-500">Jika Anda admin, gunakan <a href="admin-login.html" class="underline">Admin Login</a></p>
      <div class="mt-2 text-right"><button class="text-sm text-slate-500" onclick="closeAuth()">Tutup</button></div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-2xl rounded-lg p-4 shadow">
      <h3 class="font-semibold mb-3">Checkout</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="p-3 border rounded">
          <h4 class="font-semibold">QRIS</h4>
          <img id="qrisImage" class="w-full rounded mt-2" src="https://via.placeholder.com/320x180?text=QRIS" />
          <div class="mt-3 text-right"><button class="px-3 py-2 bg-indigo-600 text-white rounded" onclick="confirmPayment('qris')">Saya Sudah Bayar</button></div>
        </div>
        <div class="p-3 border rounded">
          <h4 class="font-semibold">Cash</h4>
          <div class="flex justify-center mt-2"><canvas id="cashQR"></canvas></div>
          <div class="mt-3 text-right"><button class="px-3 py-2 bg-indigo-600 text-white rounded" onclick="confirmPayment('cash')">Bayar di Kasir</button></div>
        </div>
      </div>
      <div class="mt-3 text-right"><button class="px-3 py-2 bg-gray-200 rounded" onclick="closeCheckout()">Tutup</button></div>
    </div>
  </div>

  <script type="module">
    import {
      listenMenu, placeOrder, listenOrders,
      loginUser, registerUser, logout, authState
    } from "./js/firebase.js";

    // state
    let user = null;
    let cart = [];

    // DOM refs
    const menuGrid = document.getElementById("menuGrid");
    const sideMenu = document.getElementById("sideMenu");

    // listeners
    listenMenu(renderMenu);

    function renderMenu(data) {
      // side list
      sideMenu.innerHTML = data.map(m => `<div class="flex justify-between"><div>${m.title}</div><div>Rp ${Number(m.price).toLocaleString()}</div></div>`).join("");

      // grid
      menuGrid.innerHTML = data.map(m => `
        <div class="bg-white rounded shadow p-3 flex flex-col">
          <img src="${m.imageUrl||'https://via.placeholder.com/420x240?text=No+Image'}" class="h-40 w-full object-cover rounded mb-3">
          <div class="flex-1">
            <h4 class="font-semibold">${m.title}</h4>
            <div class="text-sm text-slate-500">${m.desc||''}</div>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="font-semibold">Rp ${Number(m.price).toLocaleString()}</div>
            <button class="px-3 py-1 bg-indigo-600 text-white rounded" onclick="addToCart('${m.id}','${escapeHtml(m.title)}',${m.price})">Tambah</button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

    // cart
    function addToCart(id,title,price){
      const f = cart.find(x=>x.id===id);
      if(f) f.qty++; else cart.push({id,title,price:+price,qty:1});
      renderCartCount();
      Swal.fire({ icon:'success', title:'Ditambahkan', text:title, timer:700, showConfirmButton:false });
    }
    function renderCartCount(){ document.getElementById('cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0); }
    function openCart(){ document.getElementById('cartModal').classList.remove('hidden'); renderCartItems(); }
    function closeCart(){ document.getElementById('cartModal').classList.add('hidden'); }
    function clearCart(){ cart=[]; renderCartCount(); renderCartItems(); }
    function renderCartItems(){
      const wrap = document.getElementById('cartItems');
      if(cart.length===0) wrap.innerHTML = '<div class="text-slate-500">Keranjang kosong</div>';
      else wrap.innerHTML = cart.map(i => `
        <div class="flex justify-between items-center border-b py-2">
          <div>
            <div class="font-semibold">${i.title}</div>
            <div class="text-sm text-slate-500">Rp ${i.price.toLocaleString()} x ${i.qty}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 bg-gray-200 rounded" onclick="dec('${i.id}')">-</button>
            <div>${i.qty}</div>
            <button class="px-2 py-1 bg-gray-200 rounded" onclick="inc('${i.id}')">+</button>
          </div>
        </div>
      `).join('');
      document.getElementById('cartTotal').textContent = cart.reduce((s,i)=>s + i.price*i.qty, 0).toLocaleString();
    }
    function inc(id){ const f = cart.find(c=>c.id===id); if(f){ f.qty++; renderCartItems(); renderCartCount(); } }
    function dec(id){ const f = cart.find(c=>c.id===id); if(f){ f.qty = Math.max(0,f.qty-1); cart = cart.filter(i=>i.qty>0); renderCartItems(); renderCartCount(); } }

    // auth UI & actions
    function openAuth(){ document.getElementById('authModal').classList.remove('hidden'); }
    function closeAuth(){ document.getElementById('authModal').classList.add('hidden'); }

    async function doRegister(){
      const e = document.getElementById('authEmail').value.trim();
      const p = document.getElementById('authPassword').value.trim();
      if(!e||!p) return Swal.fire('Error','Isi email & password','error');
      try{
        await registerUser(e,p);
        Swal.fire('Sukses','Akun dibuat','success');
        closeAuth();
      }catch(err){
        Swal.fire('Gagal', err.message || 'Gagal register','error');
      }
    }

    async function doLogin(){
      const e = document.getElementById('authEmail').value.trim();
      const p = document.getElementById('authPassword').value.trim();
      if(!e||!p) return Swal.fire('Error','Isi email & password','error');
      try{
        await loginUser(e,p);
        Swal.fire('Sukses','Login berhasil','success');
        closeAuth();
      }catch(err){
        Swal.fire('Gagal', err.message || 'Gagal login','error');
      }
    }

    // checkout
    function openCheckout(){
      if(!user) return Swal.fire('Login dulu','Silakan login untuk checkout','info').then(()=>openAuth());
      if(cart.length===0) return Swal.fire('Kosong','Keranjang kosong','info');
      document.getElementById('checkoutModal').classList.remove('hidden');
      QRCode.toCanvas(document.getElementById('cashQR'), 'ready-to-pay', { width: 160 }).catch(()=>{});
    }
    function closeCheckout(){ document.getElementById('checkoutModal').classList.add('hidden'); }

    async function confirmPayment(method){
      if(!user) return Swal.fire('Login dulu','Login sebelum pesan','info').then(()=>openAuth());
      const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);
      const order = { items: cart, total, payment: { method, status: method==='qris' ? 'waiting_verif' : 'waiting_scan' } };
      try{
        const id = await placeOrder(user.uid, order);
        clearCart();
        closeCheckout();
        if(method === 'cash'){
          Swal.fire({
            title: 'Tunjukkan barcode ke kasir',
            html: `<div id="orderqr" class="flex justify-center"></div><p class="mt-2 text-sm text-slate-500">Order ID: ${id}</p>`,
            didOpen: ()=> QRCode.toCanvas(document.getElementById('orderqr'), id, { width: 220 })
          });
        } else {
          Swal.fire('Pesanan Diterima','Silakan tunggu verifikasi','success');
        }
      } catch(err){
        console.error(err);
        Swal.fire('Error','Gagal membuat pesanan','error');
      }
    }

    // TTS + notifications when user's order is called
    authState(u => {
      user = u;
      if(user){
        document.getElementById('greeting').textContent = greetByTime() + ', ' + (user.email || '').split('@')[0];
        document.getElementById('authBtn').textContent = 'Logout';
        document.getElementById('authBtn').onclick = async ()=> { await logout(); location.reload(); };
        document.getElementById('userNote').textContent = 'Anda akan diberi notifikasi saat pesanan dipanggil.';
      } else {
        document.getElementById('greeting').textContent = 'Selamat Datang!';
        document.getElementById('authBtn').textContent = 'Login / Register';
        document.getElementById('authBtn').onclick = openAuth;
        document.getElementById('userNote').textContent = 'Login untuk memesan dan menerima notifikasi.';
      }
    });

    // listen all orders and notify user if its order is called
    listenOrders(list => {
      list.forEach(o => {
        if(!user) return;
        if(o.userId === user.uid && o.called && !o._notified){
          o._notified = true; // local flag
          const text = `Nomor antrian Anda: ${o.queue}. Silakan ambil pesanan.`;
          Swal.fire('Dipanggil', text, 'info');
          speakTTS(text);
          if("Notification" in window){
            if(Notification.permission === 'granted') new Notification('Kantin', { body: text });
            else if(Notification.permission !== 'denied') Notification.requestPermission().then(p=>{ if(p==='granted') new Notification('Kantin', { body: text });});
          }
        }
      });
    });

    function greetByTime(){
      const hr = new Date().getHours();
      if(hr < 11) return 'Selamat Pagi';
      if(hr < 15) return 'Selamat Siang';
      if(hr < 18) return 'Selamat Sore';
      return 'Selamat Malam';
    }
    function speakTTS(text){
      try{ const s = new SpeechSynthesisUtterance(text); s.lang='id-ID'; speechSynthesis.speak(s); } catch(e){ console.warn('TTS', e); }
    }

    // expose functions to HTML click handlers
    window.addToCart = addToCart;
    window.openCart = openCart; window.closeCart = closeCart;
    window.clearCart = clearCart; window.inc = inc; window.dec = dec;
    window.openAuth = openAuth; window.closeAuth = closeAuth;
    window.doLogin = doLogin; window.doRegister = doRegister;
    window.openCheckout = openCheckout; window.closeCheckout = closeCheckout;
    window.confirmPayment = confirmPayment;

  </script>
</body>
</html>
